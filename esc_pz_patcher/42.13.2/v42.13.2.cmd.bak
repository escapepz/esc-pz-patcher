:: v42.13.2.cmd
@echo off

:: --- ADMIN CHECK ---
net session >nul 2>&1
if %errorLevel% neq 0 (
    echo [INFO] Requiring Administrator privileges...
    powershell -Command "Start-Process '%~f0' -Verb RunAs"
    exit /b
)
echo [SUCCESS] Running with Administrator privileges.

setlocal enabledelayedexpansion

:: --- INTERACTIVE MODE FLAG ---
set "INTERACTIVE_MODE=1"

:: --- CONFIGURATION ---
set "JAR_NAME=projectzomboid.jar"
set "BACKUP_NAME=projectzomboid.jar.bak"
set "SEVENZIP_PATH=C:\Program Files\7-Zip\7z.exe"
set "DEFAULT_GAME_PATH=C:\Program Files (x86)\Steam\steamapps\common\ProjectZomboid"

:: ==========================================
::   FILES TO BE PATCHED (Add/Remove here)
:: ==========================================
:: Just add a new line for each file you want to patch.  Up to 10
:: Use forward slashes / for compatibility.
set "FILES_TO_PATCH="
set "FILES_TO_PATCH=%FILES_TO_PATCH% zombie/radio/ZomboidRadio.class"
set "FILES_TO_PATCH=%FILES_TO_PATCH% zombie/iso/WorldStreamer.class"
set "FILES_TO_PATCH=%FILES_TO_PATCH% zombie/iso/IsoWorld.class"
set "FILES_TO_PATCH=%FILES_TO_PATCH% zombie/iso/IsoChunkMap.class"
set "FILES_TO_PATCH=%FILES_TO_PATCH% zombie/core/textures/MultiTextureFBO2.class"
set "FILES_TO_PATCH=%FILES_TO_PATCH% zombie/characters/PlayerCraftHistory.class"
set "FILES_TO_PATCH=%FILES_TO_PATCH% zombie/characters/ANYFILE.class"
set "FILES_TO_PATCH=%FILES_TO_PATCH% zombie/characters/ANYFILE.notclass"
:: ==========================================

:: Cleanup leading space
set "FILES_TO_PATCH=!FILES_TO_PATCH:~1!"

:: Ensure we are in the script's directory for relative class files
pushd "%~dp0"

if "!INTERACTIVE_MODE!"=="1" (
    call :INTERACTIVE_MENU
    goto :PROCEED_PATCH
)

:PROCEED_PATCH

echo [INFO] Project Zomboid Patcher starting...
echo ----------------------------------------------------

:: --- STEP 0: DETECTION ---
:: 1. Try Default Steam Path
if exist "!DEFAULT_GAME_PATH!\!JAR_NAME!" set "PZ_PATH=!DEFAULT_GAME_PATH!"
if defined PZ_PATH echo [INFO] Game detected at default path: "!DEFAULT_GAME_PATH!"

:: 2. Fallback: Registry
if not defined PZ_PATH call :DETECT_REGISTRY

:: 3. Select Target JAR
set "JAR_FILE="
if exist "!JAR_NAME!" set "JAR_FILE=!JAR_NAME!"
if exist "!JAR_NAME!" set "BACKUP_FILE=!BACKUP_NAME!"
if exist "!JAR_NAME!" echo [FOUND] !JAR_NAME! in current directory.

if defined JAR_FILE goto :START_BACKUP
if not defined PZ_PATH goto :START_BACKUP
set "JAR_FILE=!PZ_PATH!\!JAR_NAME!"
set "BACKUP_FILE=!PZ_PATH!\!BACKUP_NAME!"

:START_BACKUP

if defined JAR_FILE goto :STEP_1
echo [ERROR] !JAR_NAME! not found. 
pause
exit /b

:STEP_1

:: --- STEP 1: BACKUP ---
if exist "!BACKUP_FILE!" echo [INFO] Backup exists. Skipping.
if exist "!BACKUP_FILE!" goto :STEP_2

echo [BACKUP] Creating "!BACKUP_FILE!"...
copy "!JAR_FILE!" "!BACKUP_FILE!" >nul
if !ERRORLEVEL! EQU 0 echo [OK] Created.
if !ERRORLEVEL! NEQ 0 echo [ERROR] Failed to create backup.

:STEP_2

:: --- STEP 2: TOOL DETECTION ---
set "METHOD="
if exist "!SEVENZIP_PATH!" set "METHOD=7ZIP"
if not defined METHOD set "METHOD=POWERSHELL"

echo [INFO] Method: !METHOD!
echo [INFO] Target: "!JAR_FILE!"
echo ----------------------------------------------------

:: --- STEP 3: PATCHING ---
if "!METHOD!"=="7ZIP" call :RUN_7ZIP
if "!METHOD!"=="POWERSHELL" call :RUN_POWERSHELL

:: --- VERIFICATION ---
if %ERRORLEVEL% EQU 0 echo/
if %ERRORLEVEL% EQU 0 echo [SUCCESS] Patch applied!
if %ERRORLEVEL% NEQ 0 echo/
if %ERRORLEVEL% NEQ 0 echo [FAILED] Errors occurred.

echo ----------------------------------------------------
popd
pause
exit /b

:DETECT_REGISTRY
for /f "tokens=2*" %%A in ('reg query "HKEY_CURRENT_USER\Software\Valve\Steam" /v "SteamPath" 2^>nul') do (
    set "S_PATH=%%B"
)
if not defined S_PATH goto :EOF
set "S_PATH=!S_PATH:/=\!"
set "D_PATH=!S_PATH!\steamapps\common\ProjectZomboid"
if exist "!D_PATH!\!JAR_NAME!" set "PZ_PATH=!D_PATH!"
if exist "!D_PATH!\!JAR_NAME!" echo [INFO] Game detected via Registry.
goto :EOF

:RUN_7ZIP
echo [PROCESS] Updating JAR via 7-Zip...
for %%f in (!FILES_TO_PATCH!) do (
    echo [PROCESS] Patching %%f
    set "F=%%f"
    set "F=!F:/=\!"
    "!SEVENZIP_PATH!" a "!JAR_FILE!" "!F!"
    echo =============
)
goto :EOF

:RUN_POWERSHELL
echo [PROCESS] Updating JAR via PowerShell (.NET Fallback)...

:: Build PowerShell script line-by-line for readability
set "PS_SCRIPT="
set "PS_SCRIPT=!PS_SCRIPT! Add-Type -AssemblyName 'System.IO.Compression.FileSystem';"
set "PS_SCRIPT=!PS_SCRIPT! $zip = [System.IO.Compression.ZipFile]::Open('!JAR_FILE!', 'Update');"
set "PS_SCRIPT=!PS_SCRIPT! $files = $env:FILES_TO_PATCH -split ' ';"
set "PS_SCRIPT=!PS_SCRIPT! foreach ($f in $files) {"
set "PS_SCRIPT=!PS_SCRIPT!   if (Test-Path $f) {"
set "PS_SCRIPT=!PS_SCRIPT!     $e = $zip.GetEntry($f); if ($e) { $e.Delete() };"
set "PS_SCRIPT=!PS_SCRIPT!     [System.IO.Compression.ZipFileExtensions]::CreateEntryFromFile($zip, $f, $f);"
set "PS_SCRIPT=!PS_SCRIPT!     Write-Host \"[OK] Patched: $f\";"
set "PS_SCRIPT=!PS_SCRIPT!     Write-Host \"___\";"
set "PS_SCRIPT=!PS_SCRIPT!   }"
set "PS_SCRIPT=!PS_SCRIPT! };"
set "PS_SCRIPT=!PS_SCRIPT! $zip.Dispose();"

:: Execute the built script
powershell -NoProfile -ExecutionPolicy Bypass -Command "!PS_SCRIPT!"
goto :EOF

:VARIANT_MENU
cls
echo.
echo ============================================
echo     PATCH VARIANTS
echo ============================================
echo.
echo Select variant:
echo.
echo   1 - RenderLessZombie
echo   2 - ChunkGridConfig
echo   B - Back to main menu
echo.
set /p "VARIANT_SELECTION=Enter selection [1/2/B]: "

if /i "!VARIANT_SELECTION!"=="B" (
    set "FILES_TO_PATCH=!FILES_TO_PATCH_MAIN!"
    goto :EOF
)

if "!VARIANT_SELECTION!"=="1" (
    set "VARIANT_NAME=RenderLessZombie"
    set "VARIANT_TARGET=zombie/iso/IsoWorld.class"
    goto :SELECT_VARIANT_FILE
)

if "!VARIANT_SELECTION!"=="2" (
    set "VARIANT_NAME=ChunkGridConfig"
    set "VARIANT_TARGET=zombie/iso/IsoChunkMap.class"
    goto :SELECT_VARIANT_FILE
)

echo [ERROR] Invalid selection.
pause
goto :VARIANT_MENU

:SELECT_VARIANT_FILE
set "VARIANT_PATH=%CD%\variants\!VARIANT_NAME!"
set "VARIANT_COUNT=0"

if not exist "!VARIANT_PATH!" (
    echo [ERROR] Variant directory not found: !VARIANT_PATH!
    pause
    goto :EOF
)

cls
echo.
echo ============================================
echo     SELECT !VARIANT_NAME! VARIANT
echo ============================================
echo.
echo Available variants:
echo.

for %%i in ("!VARIANT_PATH!\*.class") do (
    set /a VARIANT_COUNT+=1
    set "VARIANT_FILE_!VARIANT_COUNT!=%%~nxi"
    echo   !VARIANT_COUNT! - %%~nxi
)

if !VARIANT_COUNT!==0 (
    echo [ERROR] No .class files found in !VARIANT_PATH!
    pause
    goto :EOF
)

echo.
echo   B - Back to variant menu
echo.
set /p "VARIANT_FILE_SELECTION=Enter selection [1-!VARIANT_COUNT!/B]: "

if /i "!VARIANT_FILE_SELECTION!"=="B" (
    set "FILES_TO_PATCH=!FILES_TO_PATCH_MAIN!"
    goto :EOF
)

set "VALID_FILE_SEL=0"
for /l %%i in (1,1,!VARIANT_COUNT!) do (
    if "!VARIANT_FILE_SELECTION!"=="%%i" (
        set "VALID_FILE_SEL=1"
        call set "SELECTED_VARIANT_FILE=%%VARIANT_FILE_!VARIANT_FILE_SELECTION!%%"
    )
)

if !VALID_FILE_SEL!==0 (
    echo [ERROR] Invalid selection.
    pause
    goto :EOF
)

:: Copy variant file to target location with base filename
set "VARIANT_SRC=!VARIANT_PATH!\!SELECTED_VARIANT_FILE!"
set "VARIANT_DST_DIR=%CD%\zombie\iso"
:: Extract base filename from VARIANT_TARGET (e.g., zombie/iso/IsoWorld.class -> IsoWorld.class)
for %%f in (!VARIANT_TARGET!) do set "VARIANT_BASE_FILE=%%~nxf"
set "VARIANT_DST=!VARIANT_DST_DIR!\!VARIANT_BASE_FILE!"

if not exist "!VARIANT_DST_DIR!" mkdir "!VARIANT_DST_DIR!"

echo [PROCESS] Copying !SELECTED_VARIANT_FILE! to !VARIANT_BASE_FILE!...
copy "!VARIANT_SRC!" "!VARIANT_DST!" >nul
if !ERRORLEVEL! EQU 0 (
    echo [OK] File copied.
) else (
    echo [ERROR] Failed to copy file.
    pause
    goto :EOF
)

:: Save current FILES_TO_PATCH and set variant
set "FILES_TO_PATCH_MAIN=!FILES_TO_PATCH!"
set "FILES_TO_PATCH=!VARIANT_TARGET!"

echo [INFO] Proceeding with variant: !SELECTED_VARIANT_FILE!
echo.
pause
goto :EOF

:INTERACTIVE_MENU
:: Save original FILES_TO_PATCH on first visit
if not defined FILES_TO_PATCH_MAIN set "FILES_TO_PATCH_MAIN=!FILES_TO_PATCH!"

:: Parse FILES_TO_PATCH into individual FILE variables (only .class files)
set "FILE_COUNT=0"
set "INVALID_COUNT=0"
for %%f in (!FILES_TO_PATCH!) do (
    if "%%~xf"==".class" (
        set /a FILE_COUNT+=1
        set "FILE_!FILE_COUNT!=%%f"
    ) else (
        set /a INVALID_COUNT+=1
    )
)

:: Initialize selection flags
set "SEL_1=0"
set "SEL_2=0"
set "SEL_3=0"
set "SEL_4=0"
set "SEL_5=0"
set "SEL_6=0"
set "SEL_7=0"
set "SEL_8=0"
set "SEL_9=0"
set "SEL_10=0"

:MENU_LOOP
cls
echo.
echo ============================================
echo     PROJECT ZOMBOID PATCHER v42.13.2
echo       FILE SELECTION MENU
echo ============================================
echo.
if !INVALID_COUNT! gtr 0 (
    echo [WARNING] !INVALID_COUNT! non-.class file^(s^) ignored from FILES_TO_PATCH.
    echo.
)
echo Select files to patch (toggle with number):
echo.
for /l %%i in (1,1,!FILE_COUNT!) do (
    if !SEL_%%i!==1 (echo   [X] %%i - !FILE_%%i!) else (echo   [ ] %%i - !FILE_%%i!)
)
echo.
echo   0 - Patch ALL files
echo   C - Confirm and patch selected
echo   V - Patch variants ^(RenderLessZombie, ChunkGridConfig^)
echo.
set /p "SELECTION=Enter selection: "

if /i "!SELECTION!"=="C" goto :VALIDATE_SELECTION
if /i "!SELECTION!"=="V" (
    call :VARIANT_MENU
    goto :MENU_LOOP
)
if /i "!SELECTION!"=="0" (
    for /l %%i in (1,1,!FILE_COUNT!) do (
        set "SEL_%%i=1"
    )
    goto :MENU_LOOP
)

:: Toggle selected file
set "VALID_TOGGLE=0"
for /l %%i in (1,1,!FILE_COUNT!) do (
    if "!SELECTION!"=="%%i" (
        set "VALID_TOGGLE=1"
        if !SEL_%%i!==1 (set "SEL_%%i=0") else (set "SEL_%%i=1")
    )
)

if !VALID_TOGGLE!==1 goto :MENU_LOOP

echo [ERROR] Invalid selection. Please try again.
pause
goto :MENU_LOOP

:VALIDATE_SELECTION
set "FILES_TO_PATCH="
set "SELECTED_COUNT=0"

for /l %%i in (1,1,!FILE_COUNT!) do (
    if !SEL_%%i!==1 (
        set "FILES_TO_PATCH=!FILES_TO_PATCH! !FILE_%%i!"
        set /a SELECTED_COUNT+=1
    )
)

if !SELECTED_COUNT!==0 (
    echo [ERROR] No files selected. Please select at least one file.
    pause
    goto :MENU_LOOP
)

set "FILES_TO_PATCH=!FILES_TO_PATCH:~1!"

cls
echo.
echo ============================================
echo     SELECTED FILES FOR PATCHING
echo ============================================
echo.
echo Files to patch (!SELECTED_COUNT!):
echo.
for /l %%i in (1,1,!FILE_COUNT!) do (
    if !SEL_%%i!==1 echo   - !FILE_%%i!
)
echo.
echo Validating selected files...
echo.

set "VALID_COUNT=0"
for /l %%i in (1,1,!FILE_COUNT!) do (
    if !SEL_%%i!==1 (
        if exist "!FILE_%%i!" (
            echo [OK] !FILE_%%i!
            set /a VALID_COUNT+=1
        ) else (
            echo [MISSING] !FILE_%%i!
        )
    )
)

echo.
if !VALID_COUNT! neq !SELECTED_COUNT! (
    echo [WARNING] !VALID_COUNT!/!SELECTED_COUNT! files found. Continue anyway? [Y/N]
    set /p "CONTINUE="
    if /i not "!CONTINUE!"=="Y" (
        echo [CANCELLED] Returning to menu.
        pause
        goto :MENU_LOOP
    )
)

echo [INFO] Proceeding with !VALID_COUNT! validated file(s).
echo.
goto :EOF
